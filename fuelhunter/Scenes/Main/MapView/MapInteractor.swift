//
//  MapInteractor.swift
//  fuelhunter
//
//  Created by Guntis on 12/08/2019.
//  Copyright (c) 2019 . All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit
import MapKit

protocol MapBusinessLogic {
  	func doSomething(request: Map.MapData.Request)
  	func userPressedOnMapPin(request: Map.MapWasPressed.Request)
  	func openHomePageForCurrentCompany()
  	func openNavigationForAppType(request: Map.MapNavigationRequested.Request)
}

protocol MapDataStore {
  	var selectedFuelType: FuelType { get set }
  	var selectedCompany: Company? { get set }
  	var selectedPricesArray: [Price]? { get set }
	var yLocation: CGFloat { get set }
}

class MapInteractor: MapBusinessLogic, MapDataStore {
	var presenter: MapPresentationLogic?
  	var worker: MapWorker?
  	var selectedFuelType: FuelType = .type95
  	var selectedCompany: Company?
	var selectedPricesArray: [Price]?
	var yLocation: CGFloat = 0

	var convertedDataArray: [Map.MapData.ViewModel.DisplayedMapPoint] = []
	var mapPoints: [MapPoint] = []
	var selectedPriceObject: Price?
	var selectedDisplayedPoint: Map.MapData.ViewModel.DisplayedMapPoint?

  	// MARK: MapBusinessLogic

  	func doSomething(request: Map.MapData.Request) {
    	worker = MapWorker()
    	convertedDataArray = worker!.createUsableDataArray(fromPricesArray: selectedPricesArray!)
		mapPoints = createMapPoints(from: convertedDataArray)

		let selectedMapPoint = mapPoints.first(where: {$0.company == selectedCompany}) ?? mapPoints.first

		selectedPriceObject = selectedPricesArray?.first(where: {$0.company == selectedCompany}) ?? selectedPricesArray?.first

		selectedDisplayedPoint = convertedDataArray.first(where: {$0.company == selectedCompany}) ?? convertedDataArray.first

		let response = Map.MapData.Response(displayedPoints: convertedDataArray, mapPoints: mapPoints, selectedDisplayedPoint: selectedDisplayedPoint, selectedMapPoint: selectedMapPoint!)

    	presenter?.presentSomething(response: response)
  	}

  	func userPressedOnMapPin(request: Map.MapWasPressed.Request) {

		selectedCompany = request.mapPoint.company

		selectedPriceObject = selectedPricesArray?.first(where: {$0.company == selectedCompany}) ?? selectedPricesArray?.first

		selectedDisplayedPoint = convertedDataArray.first(where: {$0.company == selectedCompany}) ?? convertedDataArray.first

		let response = Map.MapWasPressed.Response(selectedDisplayedPoint: selectedDisplayedPoint, selectedMapPoint: request.mapPoint, selectedPrice: selectedPriceObject!)

		presenter?.updateToRevealMapPoint(response: response)
  	}

	func openHomePageForCurrentCompany() {
		if let companyHomePage = selectedCompany?.homePage {
			UIApplication.shared.open(URL(string: companyHomePage)!, options: [:], completionHandler: nil)
		}
	}

	func openNavigationForAppType(request: Map.MapNavigationRequested.Request) {
		var url: String?
		if let selectedDisplayedPoint = selectedDisplayedPoint {
			switch request.mapAppType {
				case .Waze:
					url = "waze://?ll=\(selectedDisplayedPoint.latitude),\(selectedDisplayedPoint.longitude)&navigate=yes"
				case .GoogleMaps:
					url = "comgooglemaps://?daddr=\(selectedDisplayedPoint.latitude),\(selectedDisplayedPoint.longitude)&directionsmode=driving"
				case .iOSMaps:
					url = "http://maps.apple.com?daddr=\(selectedDisplayedPoint.latitude),\(selectedDisplayedPoint.longitude)&directionsmode=driving"
			}
		}

		if let url = url { UIApplication.shared.open(URL(string: url)!) }
	}

  	// MARK: Functions

  	func createMapPoints(from data: [Map.MapData.ViewModel.DisplayedMapPoint]) -> [MapPoint] {
  		let mapPoints = data.map { MapPoint(priceId: $0.id, title: $0.company.name, company: $0.company, address: $0.addressName, coordinate:
  			CLLocationCoordinate2D(latitude: $0.latitude, longitude: $0.longitude), priceText: $0.price, distanceInMeters: $0.distanceInMeters, priceIsCheapest: $0.isPriceCheapest) }

  		return mapPoints
  	}
}
